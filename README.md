# 语音对讲系统 - 重构版本

## 项目结构说明

优化后的项目采用了清晰的模块化架构，遵循Go语言的标准项目布局：

```
leBotChatClient/
├── cmd/                    # 应用程序入口
│   ├── main.go            # 主函数
│   └── app.go             # 应用程序核心逻辑
├── internal/              # 内部包（不对外暴露）
│   ├── config/            # 配置管理
│   │   └── config.go      # 配置结构和默认值
│   ├── websocket/         # WebSocket客户端
│   │   ├── client.go      # WebSocket客户端实现
│   │   └── types.go       # 消息类型定义
│   ├── audio/             # 音频处理
│   │   ├── recorder.go    # 音频录制器
│   │   └── player.go      # 音频播放器
│   └── control/           # 控制器
│       └── monitor.go     # 文件监控器
├── pkg/                   # 公共包（可对外暴露）
│   ├── buffer/            # 缓冲区工具
│   │   └── ring.go        # 环形缓冲区
│   └── utils/             # 工具函数
│       └── audio.go       # 音频处理工具
├── go.mod                 # Go模块定义
├── go.sum                 # 依赖校验
├── readme.md              # 项目说明
└── websocket_client_chat.go # 原始文件（可删除）
```

## 架构设计优势

### 1. 模块化设计
- **单一职责原则**: 每个模块只负责一个特定功能
- **接口驱动**: 使用接口定义组件间的交互，便于测试和扩展
- **依赖注入**: 通过构造函数注入依赖，降低耦合度

### 2. 清晰的包结构
- **cmd/**: 应用程序入口，包含main函数和应用核心逻辑
- **internal/**: 应用程序内部实现，不对外暴露
- **pkg/**: 可复用的公共包，可被其他项目引用

### 3. 配置管理
- 集中的配置管理，支持默认配置
- 结构化配置，易于维护和扩展
- 类型安全的配置项

### 4. 错误处理
- 统一的错误处理机制
- 上下文传递和优雅关闭
- 详细的日志记录

### 5. 并发安全
- 使用sync包确保并发安全
- 上下文控制goroutine生命周期
- 原子操作处理共享状态

## 主要组件

### App（应用程序核心）
- 统一管理所有组件的生命周期
- 实现各组件间的消息传递接口
- 处理应用程序的启动和关闭

### WebSocket客户端
- 自动重连机制
- 心跳检测
- 消息类型化处理
- 并发安全的消息发送

### 音频录制器
- 基于PortAudio的音频录制
- 流式音频处理
- 支持WAV格式转换
- 异步音频数据处理

### 音频播放器
- 基于环形缓冲区的音频播放
- 支持流式播放
- 自动播放状态管理
- 多种停止条件检测

### 控制器
- 文件监控机制
- 命令类型安全处理
- 异步命令执行

### 环形缓冲区
- 线程安全的环形缓冲区
- 原子操作优化性能
- 支持关闭状态检测

## 运行方式

```bash
# 方式1: 从cmd目录运行
cd cmd
go run .

# 方式2: 从根目录运行
go run ./cmd

# 方式3: 构建后运行
go build -o chat-client ./cmd
./chat-client
```

## 使用方法

系统启动后，通过控制文件进行操作：

```bash
# 开始录音
echo 1 > /tmp/chatctrl

# 停止录音并发送
echo 2 > /tmp/chatctrl
```

## 配置说明

所有配置都在 `internal/config/config.go` 中定义，包括：

- **音频配置**: 采样率、声道数、缓冲区大小等
- **WebSocket配置**: 连接URL、重连间隔、超时设置等
- **控制配置**: 控制文件路径、监控间隔等
- **设备配置**: 设备序列号、语音设置等

## 扩展性

优化后的架构支持以下扩展：

1. **新的音频格式**: 在utils包中添加新的转换函数
2. **新的传输协议**: 实现MessageHandler接口
3. **新的控制方式**: 实现Handler接口
4. **配置文件支持**: 扩展config包支持JSON/YAML配置
5. **插件系统**: 基于接口的插件架构

## 测试支持

由于采用了接口驱动的设计，每个组件都可以独立测试：

- Mock实现各个接口进行单元测试
- 依赖注入便于集成测试
- 清晰的模块边界便于性能测试

## 性能优化

1. **内存优化**: 复用缓冲区，减少内存分配
2. **并发优化**: 异步处理，避免阻塞
3. **网络优化**: 连接池和重连机制
4. **音频优化**: 流式处理，减少延迟
