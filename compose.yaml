version: '3.8'

services:
  builder:
    build:
      context: ./docker
      dockerfile: Dockerfile
    container_name: chat_client_builder
    working_dir: /workspace
    volumes:
      # 挂载项目源码
      - .:/workspace
      # 挂载工具链（方式1：如果你有本地工具链）
      # 取消注释下面这行，并修改为你的工具链路径
      # - ~/coding/t113-s3_sunxi-musl_toolchain:/opt/toolchain:ro
      
      # 持久化 Go 模块缓存
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
      
      # 持久化已编译的依赖库（避免重复编译）
      - toolchain-libs:/opt/toolchain
    environment:
      - TOOLCHAIN_PATH=/opt/toolchain
      - CGO_ENABLED=1
      - GOOS=linux
      - GOARCH=arm
      - GOARM=7
    # 一键编译：启动即完成工具链准备、依赖编译、应用编译
    command: >
      bash -c "
        set -e
        echo '=== 开始：准备工具链 ==='
        /build/build_toolchain.sh
        echo '=== 步骤 1/3：编译 ALSA/PortAudio ==='
        /build/build_dependencies.sh
        echo '=== 步骤 2/3：编译应用 ==='
        /build/build_app.sh
        echo '=== 完成：可执行文件位于 ./build/chat_client_openwrt ==='
      "

volumes:
  # Go 模块缓存
  go-mod-cache:
    driver: local
  
  # Go 构建缓存
  go-build-cache:
    driver: local
  
  # 工具链和依赖库（避免重复编译）
  toolchain-libs:
    driver: local
