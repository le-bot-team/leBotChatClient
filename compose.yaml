version: '3.8'

services:
  builder:
    build:
      context: build
      dockerfile: Dockerfile
    container_name: chat_client_builder
    working_dir: /workspace
    volumes:
      - .:/workspace
      # 挂载工具链
      # 方式1：如果你有本地工具链，可以直接挂载使用。取消注释下面这行，并修改为你的工具链路径
      # - ~/coding/t113-s3_sunxi-musl_toolchain:/opt/toolchain:ro
      # 方式2：使用容器内脚本下载和安装工具链
      - ./build/toolchain.tar.gz:/build/toolchain.tar.gz:ro
      
      # 持久化 Go 模块缓存
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
      # 持久化已编译的依赖库（避免重复编译）
      - toolchain-libs:/opt/toolchain
    environment:
      - TOOLCHAIN_PATH=/opt/toolchain
      - CGO_ENABLED=1
      - GOOS=linux
      - GOARCH=arm
      - GOARM=7
    command: >
      bash -c "
        set -e
        /build/build_toolchain.sh
        /build/build_dependencies.sh
        /build/build_app.sh
      "
volumes:
  # Go 模块缓存
  go-mod-cache:
    driver: local
  
  # Go 构建缓存
  go-build-cache:
    driver: local
  
  # 工具链和依赖库（避免重复编译）
  toolchain-libs:
    driver: local
