services:
  builder:
    build:
      context: build
      dockerfile: Dockerfile
    container_name: chat_client_builder
    working_dir: /workspace
    volumes:
      - .:/workspace
      # Mount toolchain
      # Option 1: If you have a local toolchain, mount it directly. Uncomment the line below and modify the path
      # - ~/coding/t113-s3_sunxi-musl_toolchain:/opt/toolchain:ro
      # Option 2: Use in-container script to download and install toolchain
      - ./build/toolchain.tar.gz:/build/toolchain.tar.gz:ro
      
      # Persist Go module cache
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
      # Persist compiled dependencies (avoid recompilation)
      - toolchain-libs:/opt/toolchain
    environment:
      - TOOLCHAIN_PATH=/opt/toolchain
      - CGO_ENABLED=1
      - GOOS=linux
      - GOARCH=arm
      - GOARM=7
    command: >
      bash -c "
        set -e
        /build/build_toolchain.sh
        /build/build_dependencies.sh
        /build/build_app.sh
      "
volumes:
  # Go module cache
  go-mod-cache:
    driver: local
  
  # Go build cache
  go-build-cache:
    driver: local
  
  # Toolchain and dependencies (avoid recompilation)
  toolchain-libs:
    driver: local
